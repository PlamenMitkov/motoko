"""
–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ —á–∞—Ç–±–æ—Ç –∑–∞ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ –≤ –ë—ä–ª–≥–∞—Ä–∏—è

–¢–æ–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤–∞ –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–µ–Ω –∞—Å–∏—Å—Ç–µ–Ω—Ç –∑–∞ —Ç—É—Ä–∏—Å—Ç–∏, –∫–æ–π—Ç–æ –ø–æ–º–∞–≥–∞
–ø—Ä–∏ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ—Ç–æ –∏ –ø–ª–∞–Ω–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏ –ø–æ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ –≤ –ë—ä–ª–≥–∞—Ä–∏—è.
–ò–∑–ø–æ–ª–∑–≤–∞ Flask –∑–∞ —É–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ OpenAI GPT –º–æ–¥–µ–ª –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏.

–ê–≤—Ç–æ—Ä: [–í–∞—à–µ—Ç–æ –∏–º–µ]
–î–∞—Ç–∞: 2025
–í–µ—Ä—Å–∏—è: 1.0
"""

import os
import json
import re
from typing import Dict, List, Optional, Tuple, Any, Union

from flask import Flask, render_template, request, jsonify, session
from openai import OpenAI
from dotenv import load_dotenv
import openrouteservice

from query import search_trails, get_trail_by_id, advanced_search, list_all_trails

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# ============================================================================

# –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏—Ç–µ –æ—Ç .env —Ñ–∞–π–ª–∞ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç
load_dotenv()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ OpenAI –∫–ª–∏–µ–Ω—Ç–∞ —Å API –∫–ª—é—á –æ—Ç environment variables
openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ OpenRouteService –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏
ORS_API_KEY = os.getenv("OPENROUTESERVICE_API_KEY")
ors_client = openrouteservice.Client(key=ORS_API_KEY)

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ
app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET_KEY")

# ============================================================================
# –ö–û–ù–°–¢–ê–ù–¢–ò –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================================

# –ú–∞–∫—Å–∏–º–∞–ª–µ–Ω –±—Ä–æ–π —Å—ä–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
MAX_CONVERSATION_HISTORY = 10

# –ú–∞–∫—Å–∏–º–∞–ª–Ω–∞ –¥—ä–ª–∂–∏–Ω–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ —Å—ä–æ–±—â–µ–Ω–∏–µ (–∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
MAX_MESSAGE_LENGTH = 500

# –ì–µ–æ–≥—Ä–∞—Ñ—Å–∫–∏ –≥—Ä–∞–Ω–∏—Ü–∏ –Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è –∑–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
BULGARIA_BOUNDS = {
    'min_lat': 41.2,
    'max_lat': 44.2,
    'min_lng': 22.3,
    'max_lng': 28.6
}

# –û–±—â–∏ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∏ –≥—Ä–∞–Ω–∏—Ü–∏ –∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
COORDINATE_BOUNDS = {
    'min_lat': -90.0,
    'max_lat': 90.0,
    'min_lng': -180.0,
    'max_lng': 180.0
}

# ============================================================================
# –°–ò–°–¢–ï–ú–ù–ò –ü–†–û–ú–ü–¢–û–í–ï –ó–ê AI –ú–û–î–ï–õ–ê
# ============================================================================

SYSTEM_PROMPT = """
–¢–∏ —Å–∏ –µ–∫—Å–ø–µ—Ä—Ç–µ–Ω —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∞—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω –≤ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ –∏ –ø—Ä–∏—Ä–æ–¥–µ–Ω —Ç—É—Ä–∏–∑—ä–º –≤ –ë—ä–ª–≥–∞—Ä–∏—è.

–¢–í–û–Ø–¢–ê –†–û–õ–Ø:
- –ü–æ–º–∞–≥–∞—à –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏—Ç–µ –¥–∞ –æ—Ç–∫—Ä–∏—è—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ —Å–ø–æ—Ä–µ–¥ —Ç–µ—Ö–Ω–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—è—à —Ç–æ—á–Ω–∞ –∏ –ø–æ–ª–µ–∑–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∏, —Ç—Ä—É–¥–Ω–æ—Å—Ç, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç
- –î–∞–≤–∞—à –ø—Ä–∞–∫—Ç–∏—á–Ω–∏ —Å—ä–≤–µ—Ç–∏ –∑–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç

–§–û–†–ú–ê–¢ –ù–ê –û–¢–ì–û–í–û–†–ê:
–ö–æ–≥–∞—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Å–ø–æ–º–µ–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –º—è—Å—Ç–æ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç, –æ—Ç–≥–æ–≤–æ—Ä–∏ —Å –≤–∞–ª–∏–¥–µ–Ω JSON:

{
"response": "–û–ø–∏—Å–∞—Ç–µ–ª–µ–Ω —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ –Ω–µ–≥–æ",
"coords": { "lat": <latitude>, "lng": <longitude> }
}

–í–ê–ñ–ù–ò –ü–†–ê–í–ò–õ–ê:
- –ù–ï –¥–æ–±–∞–≤—è–π —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥–∏ –∏–ª–∏ —Å–ª–µ–¥ JSON
- –ù–ï –∏–∑–ø–æ–ª–∑–≤–∞–π markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ
- –ê–∫–æ –Ω–µ –∑–Ω–∞–µ—à –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ, –≤—ä—Ä–Ω–∏ —Å–∞–º–æ: { "response": "..." }
- –ë—ä–¥–∏ —Ç–æ—á–µ–Ω, –ø–æ–ª–µ–∑–µ–Ω –∏ –Ω–∞—Å—ä—Ä—á–∞–≤–∞—â

–°–¢–ò–õ –ù–ê –ö–û–ú–£–ù–ò–ö–ê–¶–ò–Ø:
- –ü—Ä–∏—è—Ç–µ–ª—Å–∫–∏ –∏ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω —Ç–æ–Ω
- –ò–∑–ø–æ–ª–∑–≤–∞–π –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–∏ —Å—ä–≤–µ—Ç–∏
"""

FAQ_CONTENT = """
–ß–ï–°–¢–û –ó–ê–î–ê–í–ê–ù–ò –í–™–ü–†–û–°–ò –ó–ê –ï–ö–û–ü–™–¢–ï–ö–ò–¢–ï –í –ë–™–õ–ì–ê–†–ò–Ø

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üåø –û–°–ù–û–í–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø

‚ùì –ö–∞–∫–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤–∞ –µ–∫–æ–ø—ä—Ç–µ–∫–∞—Ç–∞?
–ï–∫–æ–ø—ä—Ç–µ–∫–∞—Ç–∞ –µ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω –º–∞—Ä—à—Ä—É—Ç –≤ –ø—Ä–∏—Ä–æ–¥–∞—Ç–∞, –ø—Ä–æ–µ–∫—Ç–∏—Ä–∞–Ω –¥–∞ –º–∏–Ω–∏–º–∏–∑–∏—Ä–∞ 
–≤—ä–∑–¥–µ–π—Å—Ç–≤–∏–µ—Ç–æ –≤—ä—Ä—Ö—É –æ–∫–æ–ª–Ω–∞—Ç–∞ —Å—Ä–µ–¥–∞, –∫–∞—Ç–æ —Å—ä—â–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç –∑–∞ 
–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–Ω–∏ –∏ —Ä–µ–∫—Ä–µ–∞—Ü–∏–æ–Ω–Ω–∏ –¥–µ–π–Ω–æ—Å—Ç–∏.

‚ùì –ö–∞–∫–≤–∞ –µ –æ—Å–Ω–æ–≤–Ω–∞—Ç–∞ —Ü–µ–ª?
–¶–µ–ª—Ç–∞ –µ –Ω–∞—Å—ä—Ä—á–∞–≤–∞–Ω–µ –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤ —Ç—É—Ä–∏–∑—ä–º, –æ–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –±–∏–æ—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ—Ç–æ –∏ 
–µ–∫–æ–ª–æ–≥–∏—á–Ω–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏—Ç–µ.

üéØ –ò–ó–ë–û–† –ù–ê –ú–ê–†–®–†–£–¢

‚ùì –ö–∞–∫ –¥–∞ –∏–∑–±–µ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–∞ –µ–∫–æ–ø—ä—Ç–µ–∫–∞?
- –û—Ü–µ–Ω–µ—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—Ç–∞ —Å–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥—ä–ª–∂–∏–Ω–∞—Ç–∞ –∏ –¥–µ–Ω–∏–≤–µ–ª–∞—Ü–∏—è—Ç–∞
- –í–∏–∂—Ç–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞—Ç–∞ –∑–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç
- –°—ä–æ–±—Ä–∞–∑–µ—Ç–µ —Å–µ —Å—ä—Å —Å–µ–∑–æ–Ω–∞ –∏ –≤—Ä–µ–º–µ—Ç–æ

‚ùì –ü–æ–¥—Ö–æ–¥—è—â–∏ –ª–∏ —Å–∞ –∑–∞ –¥–µ—Ü–∞?
–ú–Ω–æ–≥–æ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ —Å–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏ –∑–∞ —Å–µ–º–µ–π—Å—Ç–≤–∞ —Å –¥–µ—Ü–∞. –¢—ä—Ä—Å–µ—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏ —Å:
- –ù–∏—Å–∫–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç
- –ö—Ä–∞—Ç–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—è (–¥–æ 3-4 –∫–º)
- –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∏ –æ–±–µ–∫—Ç–∏ –ø–æ –ø—ä—Ç—è
- –î–æ–±—Ä–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ—Å—Ç

üéí –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ï–ö–ò–ü–ò–†–û–í–ö–ê

‚ùì –ö–∞–∫–≤–∞ –µ–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞?
–ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–û:
- –£–¥–æ–±–Ω–∏ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏ –æ–±—É–≤–∫–∏
- –î–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –≤–æ–¥–∞ (–º–∏–Ω–∏–º—É–º 1–ª –Ω–∞ —á–æ–≤–µ–∫)
- –õ–µ–∫–∞ —Ö—Ä–∞–Ω–∞ –∏ –∑–∞–∫—É—Å–∫–∏
- –ü—ä—Ä–≤–∞ –ø–æ–º–æ—â
- –ú–æ–±–∏–ª–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω —Å GPS

–ü–†–ï–ü–û–†–™–ß–ò–¢–ï–õ–ù–û:
- –î—ä–∂–¥–æ–±—Ä–∞–Ω –∏–ª–∏ –≤–µ—Ç—Ä–æ–≤–∫–∞
- –°–ª—ä–Ω—Ü–µ–∑–∞—â–∏—Ç–µ–Ω –∫—Ä–µ–º –∏ —à–∞–ø–∫–∞
- –ö–∞—Ä—Ç–∞ –∏–ª–∏ GPS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- –§–µ–Ω–µ—Ä—á–µ (–∑–∞ –¥—ä–ª–≥–∏ –º–∞—Ä—à—Ä—É—Ç–∏)

üß≠ –û–†–ò–ï–ù–¢–ò–†–ê–ù–ï –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢

‚ùì –ö–∞–∫ –¥–∞ —Å–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞–º?
- –°–ª–µ–¥–≤–∞–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏—Ç–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏
- –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ GPS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–æ—Å–µ—Ç–µ —Ö–∞—Ä—Ç–∏–µ–Ω–∞ –∫–∞—Ä—Ç–∞ –∫–∞—Ç–æ —Ä–µ–∑–µ—Ä–≤–∞
- –ò–Ω—Ñ–æ—Ä–º–∏—Ä–∞–π—Ç–µ –±–ª–∏–∑–∫–∏ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å–∏

‚ùì –ö–∞–∫–≤–æ –ø—Ä–∏ —Å–ø–µ—à–µ–Ω —Å–ª—É—á–∞–π?
- –û–±–∞–¥–µ—Ç–µ —Å–µ –Ω–∞ 112
- –û–ø–∏—à–µ—Ç–µ —Ç–æ—á–Ω–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ—Ç–æ —Å–∏
- –û—Å—Ç–∞–Ω–µ—Ç–µ –Ω–∞ –º—è—Å—Ç–æ—Ç–æ –∞–∫–æ —Å—Ç–µ –∏–∑–≥—É–±–µ–Ω–∏
- –ü–µ—Å—Ç–µ—Ç–µ –±–∞—Ç–µ—Ä–∏—è—Ç–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

üöó –î–û–°–¢–™–ü–ù–û–°–¢ –ò –õ–û–ì–ò–°–¢–ò–ö–ê

‚ùì –ö–∞–∫ –¥–∞ —Å—Ç–∏–≥–Ω–∞ –¥–æ –Ω–∞—á–∞–ª–æ—Ç–æ?
- –ü–æ–≤–µ—á–µ—Ç–æ –µ–∫–æ–ø—ä—Ç–µ–∫–∏ –∏–º–∞—Ç –ø–∞—Ä–∫–∏–Ω–≥
- –ù—è–∫–æ–∏ —Å–∞ –¥–æ—Å—Ç—ä–ø–Ω–∏ —Å –æ–±—â–µ—Å—Ç–≤–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –Ω–∞ –ø—ä—Ç–∏—â–∞—Ç–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–æ
- –ü–ª–∞–Ω–∏—Ä–∞–π—Ç–µ –≤—Ä–µ–º–µ—Ç–æ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ

üå± –ï–ö–û–õ–û–ì–ò–ß–ù–û –ü–û–í–ï–î–ï–ù–ò–ï

‚ùì –ö–∞–∫ –¥–∞ –æ–ø–∞–∑—è –ø—Ä–∏—Ä–æ–¥–∞—Ç–∞?
–ó–õ–ê–¢–ù–ò –ü–†–ê–í–ò–õ–ê:
- –ù–µ –æ—Å—Ç–∞–≤—è–π—Ç–µ –æ—Ç–ø–∞–¥—ä—Ü–∏
- –ù–µ –∫—ä—Å–∞–π—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
- –ù–µ –±–µ–∑–ø–æ–∫–æ–π—Ç–µ –∂–∏–≤–æ—Ç–Ω–∏—Ç–µ
- –û—Å—Ç–∞–Ω–µ—Ç–µ –Ω–∞ –º–∞—Ä–∫–∏—Ä–∞–Ω–∞—Ç–∞ –ø—ä—Ç–µ–∫–∞
- –ù–µ –∑–∞–ø–∞–ª–≤–∞–π—Ç–µ –æ–≥—ä–Ω –∏–∑–≤—ä–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—Ç–µ –º–µ—Å—Ç–∞

‚ùì –ú–æ–≥–∞ –ª–∏ –¥–∞ –≤–æ–¥—è –¥–æ–º–∞—à–µ–Ω –ª—é–±–∏–º–µ—Ü?
–î–∞, –Ω–æ:
- –ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –Ω–∞ –ø–æ–≤–æ–¥
- –ü–æ—á–∏—Å—Ç–≤–∞–π—Ç–µ —Å–ª–µ–¥ –Ω–µ–≥–æ
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ä—Ç –ø–æ–∑–≤–æ–ª—è–≤–∞ –∂–∏–≤–æ—Ç–Ω–∏
- –ù–æ—Å–µ—Ç–µ –≤–æ–¥–∞ –∏ –∑–∞ –∫—É—á–µ—Ç–æ

üìÖ –°–ï–ó–û–ù–ù–û–°–¢ –ò –í–†–ï–ú–ï

‚ùì –ö–æ–≥–∞ –µ –Ω–∞–π-–¥–æ–±—Ä–µ –¥–∞ –ø–æ—Å–µ—Ç—è –µ–∫–æ–ø—ä—Ç–µ–∫–∞?
- –ü—Ä–æ–ª–µ—Ç (–∞–ø—Ä–∏–ª-–º–∞–π): —Ü—ä—Ñ—Ç—è—â–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è
- –õ—è—Ç–æ (—é–Ω–∏-–∞–≤–≥—É—Å—Ç): –¥—ä–ª–≥–∏ –¥–Ω–∏, –Ω–æ –≥–æ—Ä–µ—â–æ
- –ï—Å–µ–Ω (—Å–µ–ø—Ç–µ–º–≤—Ä–∏-–æ–∫—Ç–æ–º–≤—Ä–∏): –∫—Ä–∞—Å–∏–≤–∏ —Ü–≤–µ—Ç–æ–≤–µ
- –ó–∏–º–∞: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω—É–∂–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

‚ùì –ö–∞–∫–≤–æ –≤—Ä–µ–º–µ –µ –ø–æ–¥—Ö–æ–¥—è—â–æ?
- –ò–∑–±—è–≥–≤–∞–π—Ç–µ –¥—ä–∂–¥–æ–≤–Ω–∏ –¥–Ω–∏
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑–∞—Ç–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–æ
- –†–∞–Ω–Ω–∏—Ç–µ —á–∞—Å–æ–≤–µ —Å–∞ –Ω–∞–π-–ø—Ä–∏—è—Ç–Ω–∏
- –í–Ω–∏–º–∞–≤–∞–π—Ç–µ —Å –º—ä–≥–ª–∞—Ç–∞ –≤ –ø–ª–∞–Ω–∏–Ω–∏—Ç–µ
"""

# ============================================================================
# –ü–û–ú–û–©–ù–ò –§–£–ù–ö–¶–ò–ò –ó–ê –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ö–ê
# ============================================================================

def validate_coordinates(latitude: float, longitude: float) -> Tuple[bool, str]:
    """
    –í–∞–ª–∏–¥–∏—Ä–∞ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ—Å—Ç –∏ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ë—ä–ª–≥–∞—Ä–∏—è.
    
    –§—É–Ω–∫—Ü–∏—è—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–∞ –≤ –¥–æ–ø—É—Å—Ç–∏–º–∏—Ç–µ –≥—Ä–∞–Ω–∏—Ü–∏
    –∏ –¥–∞–ª–∏ –ø–æ–ø–∞–¥–∞—Ç –≤ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∞—Ç–∞ –æ–±–ª–∞—Å—Ç –Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è.
    
    Args:
        latitude (float): –ì–µ–æ–≥—Ä–∞—Ñ—Å–∫–∞ —à–∏—Ä–∏–Ω–∞ –≤ –≥—Ä–∞–¥—É—Å–∏
        longitude (float): –ì–µ–æ–≥—Ä–∞—Ñ—Å–∫–∞ –¥—ä–ª–∂–∏–Ω–∞ –≤ –≥—Ä–∞–¥—É—Å–∏
    
    Returns:
        Tuple[bool, str]: –ö–æ—Ä—Ç–µ–∂ —Å—ä–¥—ä—Ä–∂–∞—â:
            - bool: True –∞–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ —Å–∞ –≤–∞–ª–∏–¥–Ω–∏, False –≤ –ø—Ä–æ—Ç–∏–≤–µ–Ω —Å–ª—É—á–∞–π
            - str: –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –∏–ª–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –≥—Ä–µ—à–∫–∞
    
    Raises:
        ValueError: –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∏ –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏
        TypeError: –ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª–µ–Ω —Ç–∏–ø –Ω–∞ –≤—Ö–æ–¥–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
    """
    try:
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ –∫—ä–º float –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç
        lat = float(latitude)
        lng = float(longitude)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∏ –≥—Ä–∞–Ω–∏—Ü–∏
        if not (COORDINATE_BOUNDS['min_lat'] <= lat <= COORDINATE_BOUNDS['max_lat']):
            return False, (
                f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∞ —à–∏—Ä–∏–Ω–∞: {lat}¬∞. "
                f"–¢—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –º–µ–∂–¥—É {COORDINATE_BOUNDS['min_lat']}¬∞ –∏ {COORDINATE_BOUNDS['max_lat']}¬∞."
            )
        
        if not (COORDINATE_BOUNDS['min_lng'] <= lng <= COORDINATE_BOUNDS['max_lng']):
            return False, (
                f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ—Å–∫–∞ –¥—ä–ª–∂–∏–Ω–∞: {lng}¬∞. "
                f"–¢—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –º–µ–∂–¥—É {COORDINATE_BOUNDS['min_lng']}¬∞ –∏ {COORDINATE_BOUNDS['max_lng']}¬∞."
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –ø–æ–ø–∞–¥–∞—Ç –≤ –≥—Ä–∞–Ω–∏—Ü–∏—Ç–µ –Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è
        if not (BULGARIA_BOUNDS['min_lat'] <= lat <= BULGARIA_BOUNDS['max_lat'] and 
                BULGARIA_BOUNDS['min_lng'] <= lng <= BULGARIA_BOUNDS['max_lng']):
            return False, (
                f"–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ ({lat}¬∞, {lng}¬∞) –Ω–µ –ø–æ–ø–∞–¥–∞—Ç –≤ –≥—Ä–∞–Ω–∏—Ü–∏—Ç–µ –Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è. "
                f"–û—á–∞–∫–≤–∞–Ω–∏—Ç–µ –≥—Ä–∞–Ω–∏—Ü–∏ —Å–∞: {BULGARIA_BOUNDS['min_lat']}¬∞-{BULGARIA_BOUNDS['max_lat']}¬∞ "
                f"(—à–∏—Ä–∏–Ω–∞) –∏ {BULGARIA_BOUNDS['min_lng']}¬∞-{BULGARIA_BOUNDS['max_lng']}¬∞ (–¥—ä–ª–∂–∏–Ω–∞)."
            )
        
        return True, f"–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ ({lat}¬∞, {lng}¬∞) —Å–∞ –≤–∞–ª–∏–¥–Ω–∏ –∑–∞ –ë—ä–ª–≥–∞—Ä–∏—è."
        
    except (ValueError, TypeError) as e:
        return False, f"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ: {str(e)}"


def sanitize_user_input(message: str) -> str:
    """
    –ü–æ—á–∏—Å—Ç–≤–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏—è –≤—Ö–æ–¥ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç.
    
    –§—É–Ω–∫—Ü–∏—è—Ç–∞ –ø—Ä–µ–º–∞—Ö–≤–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–Ω–æ –æ–ø–∞—Å–Ω–∏ —Å–∏–º–≤–æ–ª–∏, –æ–≥—Ä–∞–Ω–∏—á–∞–≤–∞ –¥—ä–ª–∂–∏–Ω–∞—Ç–∞
    –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –∑–∞ –ø–æ-–±–µ–∑–æ–ø–∞—Å–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞.
    
    Args:
        message (str): –û—Ä–∏–≥–∏–Ω–∞–ª–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
    
    Returns:
        str: –ü–æ—á–∏—Å—Ç–µ–Ω–æ—Ç–æ –∏ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ
    """
    if not isinstance(message, str):
        return ""
    
    # –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –∏–∑–ª–∏—à–Ω–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –∏ –∫—Ä–∞—è
    message = message.strip()
    
    # –û–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ –Ω–∞ –¥—ä–ª–∂–∏–Ω–∞—Ç–∞ –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–∞
    if len(message) > MAX_MESSAGE_LENGTH:
        message = message[:MAX_MESSAGE_LENGTH]
    
    # –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–Ω–æ –æ–ø–∞—Å–Ω–∏ HTML —Ç–∞–≥–æ–≤–µ
    message = re.sub(r'<[^>]+>', '', message)
    
    # –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏
    message = re.sub(r'\s+', ' ', message)
    
    return message


def build_context_from_trails(trails: List[Dict[str, Any]]) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω —Ç–µ–∫—Å—Ç–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç —Å–ø–∏—Å—ä–∫ —Å –º–∞—Ä—à—Ä—É—Ç–∏.
    
    –§—É–Ω–∫—Ü–∏—è—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–≤–∞ –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∏ –∏ —Å—ä–∑–¥–∞–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω —Ç–µ–∫—Å—Ç
    –∫–æ–π—Ç–æ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –æ—Ç AI –º–æ–¥–µ–ª–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏.
    
    Args:
        trails (List[Dict[str, Any]]): –°–ø–∏—Å—ä–∫ —Å –¥–∞–Ω–Ω–∏ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∏ –æ—Ç –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
    
    Returns:
        str: –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω —Ç–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ
    """
    if not trails:
        return "–í –º–æ–º–µ–Ω—Ç–∞ –Ω—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏, –æ—Ç–≥–æ–≤–∞—Ä—è—â–∏ –Ω–∞ –∫—Ä–∏—Ç–µ—Ä–∏–∏—Ç–µ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ."
    
    context_parts = [
        "–ù–ê–õ–ò–ß–ù–ò –ï–ö–û–ü–™–¢–ï–ö–ò –í –ë–ê–ó–ê–¢–ê –î–ê–ù–ù–ò:",
        "=" * 50
    ]
    
    for index, trail in enumerate(trails, 1):
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å fallback —Å—Ç–æ–π–Ω–æ—Å—Ç–∏
        name = trail.get('name', f'–ù–µ–∏–º–µ–Ω–æ–≤–∞–Ω –º–∞—Ä—à—Ä—É—Ç #{index}')
        description = trail.get('description', '–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ')
        
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫–æ –µ –Ω–∞–ª–∏—á–Ω–∞
        trail_details = trail.get('trail_details', {})
        location_info = trail.get('location', {})
        
        difficulty = trail_details.get('difficulty', '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç')
        region = location_info.get('region', '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω —Ä–µ–≥–∏–æ–Ω')
        duration = trail_details.get('duration', '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç')
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞
        trail_info = [
            f"\n{index}. {name}",
            f"   –†–µ–≥–∏–æ–Ω: {region}",
            f"   –¢—Ä—É–¥–Ω–æ—Å—Ç: {difficulty}",
            f"   –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: {duration}",
            f"   –û–ø–∏—Å–∞–Ω–∏–µ: {description}",
            "-" * 40
        ]
        
        context_parts.extend(trail_info)
    
    return "\n".join(context_parts)


def manage_conversation_history(
    history: List[Dict[str, str]], 
    new_message: Dict[str, str], 
    max_length: int = MAX_CONVERSATION_HISTORY
) -> List[Dict[str, str]]:
    """
    –£–ø—Ä–∞–≤–ª—è–≤–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∫–∞—Ç–æ –ø–æ–¥–¥—ä—Ä–∂–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä.
    
    –§—É–Ω–∫—Ü–∏—è—Ç–∞ –¥–æ–±–∞–≤—è –Ω–æ–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ –ø—Ä–µ–º–∞—Ö–≤–∞ –Ω–∞–π-—Å—Ç–∞—Ä–∏—Ç–µ
    –∑–∞–ø–∏—Å–∏ –∞–∫–æ –æ–±—â–∏—è—Ç –±—Ä–æ–π –Ω–∞–¥–≤–∏—à–∞–≤–∞ –º–∞–∫—Å–∏–º–∞–ª–Ω–∏—è –ª–∏–º–∏—Ç.
    
    Args:
        history (List[Dict[str, str]]): –¢–µ–∫—É—â–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        new_message (Dict[str, str]): –ù–æ–≤–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ
        max_length (int): –ú–∞–∫—Å–∏–º–∞–ª–µ–Ω –±—Ä–æ–π —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ
    
    Returns:
        List[Dict[str, str]]: –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    """
    # –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ
    history.append(new_message)
    
    # –ó–∞–ø–∞–∑–≤–∞–Ω–µ —Å–∞–º–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏—è
    if len(history) > max_length:
        history = history[-max_length:]
    
    return history


def parse_gpt_response(content: str) -> Dict[str, Any]:
    """
    –ü–∞—Ä—Å–≤–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ –æ—Ç GPT –º–æ–¥–µ–ª–∞.
    
    –§—É–Ω–∫—Ü–∏—è—Ç–∞ —Å–µ –æ–ø–∏—Ç–≤–∞ –¥–∞ –∏–∑–≤–ª–µ—á–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ GPT,
    –≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ —Ç–µ–∫—Å—Ç –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏, –∏ –≤–∞–ª–∏–¥–∏—Ä–∞ —Ç—è—Ö–Ω–∞—Ç–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ—Å—Ç.
    
    Args:
        content (str): –¢–µ–∫—Å—Ç–æ–≤–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç GPT –º–æ–¥–µ–ª–∞
    
    Returns:
        Dict[str, Any]: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω –æ—Ç–≥–æ–≤–æ—Ä —Å –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏
    """
    try:
        # –û–ø–∏—Ç –∑–∞ –ø–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ JSON –æ—Ç–≥–æ–≤–æ—Ä–∞
        parsed_data = json.loads(content)
        
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏—è —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞
        response_text = parsed_data.get('response', '')
        coordinates = parsed_data.get('coords')
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
        result = {'response': response_text}
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ –∞–∫–æ —Å–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–∏
        if coordinates and isinstance(coordinates, dict):
            lat = coordinates.get('lat')
            lng = coordinates.get('lng')
            
            if lat is not None and lng is not None:
                is_valid, validation_message = validate_coordinates(lat, lng)
                
                if is_valid:
                    result['coords'] = coordinates
                else:
                    # –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                    result['response'] += f"\n\n‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: {validation_message}"
        
        return result
        
    except json.JSONDecodeError:
        # –ê–∫–æ –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω JSON, —Ç—Ä–µ—Ç–∏—Ä–∞–º–µ –≥–æ –∫–∞—Ç–æ –æ–±–∏–∫–Ω–æ–≤–µ–Ω —Ç–µ–∫—Å—Ç
        return {'response': content}
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –Ω–µ–æ—á–∞–∫–≤–∞–Ω–∏ –≥—Ä–µ—à–∫–∏
        return {
            'response': content,
            'warning': f'–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞: {str(e)}'
        }

# ============================================================================
# –û–°–ù–û–í–ù–ò –ú–ê–†–®–†–£–¢–ò –ù–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–ï–¢–û
# ============================================================================

@app.route('/')
def home():
    """
    –ó–∞—Ä–µ–∂–¥–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.
    
    –¢–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Å–ª—É–∂–≤–∞ GET –∑–∞—è–≤–∫–∏ –∫—ä–º –æ—Å–Ω–æ–≤–Ω–∏—è URL –∏ –≤—Ä—ä—â–∞
    HTML —à–∞–±–ª–æ–Ω–∞ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
    
    Returns:
        str: HTML —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    """
    return render_template('index.html')


@app.route('/querydata', methods=['POST'])
def query_data():
    """
    –û—Å–Ω–æ–≤–Ω–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∑–∞—è–≤–∫–∏ –æ—Ç —á–∞—Ç–±–æ—Ç–∞.
    
    –¢–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–µ–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è, —Ç—ä—Ä—Å–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏ –º–∞—Ä—à—Ä—É—Ç–∏
    –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä —á—Ä–µ–∑ OpenAI GPT –º–æ–¥–µ–ª.
    
    Returns:
        Response: JSON –æ—Ç–≥–æ–≤–æ—Ä —Å—ä–¥—ä—Ä–∂–∞—â —Ç–µ–∫—Å—Ç –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (–∞–∫–æ –∏–º–∞)
    
    Raises:
        400: –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ –∑–∞—è–≤–∫–∞ –∏–ª–∏ –ª–∏–ø—Å–≤–∞—â–∏ –¥–∞–Ω–Ω–∏
        500: –ü—Ä–∏ –≤—ä—Ç—Ä–µ—à–Ω–∞ –≥—Ä–µ—à–∫–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
        request_data = request.json
        if not request_data or 'message' not in request_data:
            return jsonify({
                'response': '–ù–µ–≤–∞–ª–∏–¥–Ω–∞ –∑–∞—è–≤–∫–∞. –ú–æ–ª—è, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ.',
                'error': 'INVALID_REQUEST'
            }), 400
        
        # –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ
        user_message = sanitize_user_input(request_data.get('message', ''))
        
        if not user_message:
            return jsonify({
                'response': '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ.',
                'error': 'EMPTY_MESSAGE'
            }), 400
        
        print(f"üì® –ü–æ–ª—É—á–µ–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ: '{user_message}'")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–µ—Å–∏—è—Ç–∞ –∑–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if 'conversation_history' not in session:
            session['conversation_history'] = []
        
        conversation_history = session['conversation_history']
        
        # –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
        conversation_history = manage_conversation_history(
            conversation_history,
            {"role": "user", "content": user_message}
        )
        
        # –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
        matching_trails = search_trails(user_message)
        print(f"üîç –ù–∞–º–µ—Ä–µ–Ω–∏ {len(matching_trails)} –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ AI –º–æ–¥–µ–ª–∞
        trails_context = build_context_from_trails(matching_trails)
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ –∑–∞ GPT –º–æ–¥–µ–ª–∞
        gpt_messages = [
            {"role": "system", "content": SYSTEM_PROMPT + "\n\n" + trails_context},
            {"role": "assistant", "content": FAQ_CONTENT},
            *conversation_history
        ]
        
        # –ò–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ OpenAI API –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä
        print("ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä —á—Ä–µ–∑ OpenAI...")
        gpt_response = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=gpt_messages,
            temperature=0.0,
            max_tokens=384
        )
        
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–∞
        response_content = gpt_response.choices[0].message.content.strip()
        print(f"‚úÖ GPT –æ—Ç–≥–æ–≤–æ—Ä –ø–æ–ª—É—á–µ–Ω: {len(response_content)} —Å–∏–º–≤–æ–ª–∞")
        
        # –ü–∞—Ä—Å–≤–∞–Ω–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞
        processed_response = parse_gpt_response(response_content)
        
        # –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        conversation_history = manage_conversation_history(
            conversation_history,
            {"role": "assistant", "content": processed_response['response']}
        )
        
        # –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –≤ —Å–µ—Å–∏—è—Ç–∞
        session['conversation_history'] = conversation_history
        
        return jsonify(processed_response)
        
    except Exception as e:
        error_message = f"–í—ä–∑–Ω–∏–∫–Ω–∞ –Ω–µ–æ—á–∞–∫–≤–∞–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞ –Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞: {str(e)}"
        print(f"‚ùå –ì—Ä–µ—à–∫–∞ –≤ query_data: {error_message}")
        
        return jsonify({
            'response': '–ò–∑–≤–∏–Ω—è–≤–∞–º —Å–µ, –Ω–æ –≤—ä–∑–Ω–∏–∫–Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞ –≥—Ä–µ—à–∫–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.',
            'error': 'INTERNAL_ERROR',
            'details': str(e) if app.debug else None
        }), 500


@app.route("/trails/by_id/<trail_id>", methods=['GET'])
def get_trail_details(trail_id: str):
    """
    –í—Ä—ä—â–∞ –ø–æ–¥—Ä–æ–±–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –º–∞—Ä—à—Ä—É—Ç –ø–æ –Ω–µ–≥–æ–≤–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
    
    Args:
        trail_id (str): –£–Ω–∏–∫–∞–ª–Ω–∏—è—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞
    
    Returns:
        Response: JSON –¥–∞–Ω–Ω–∏ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–ª–∏ –≥—Ä–µ—à–∫–∞ –∞–∫–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—ä—Ä
        if not trail_id or not isinstance(trail_id, str):
            return jsonify({
                'error': '–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –º–∞—Ä—à—Ä—É—Ç',
                'code': 'INVALID_TRAIL_ID'
            }), 400
        
        # –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
        trail_data = get_trail_by_id(trail_id)
        
        if trail_data:
            print(f"‚úÖ –ù–∞–º–µ—Ä–µ–Ω –º–∞—Ä—à—Ä—É—Ç —Å ID: {trail_id}")
            return jsonify(trail_data)
        else:
            print(f"‚ùå –ú–∞—Ä—à—Ä—É—Ç —Å ID '{trail_id}' –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω")
            return jsonify({
                'error': f'–ú–∞—Ä—à—Ä—É—Ç —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä "{trail_id}" –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞',
                'code': 'TRAIL_NOT_FOUND'
            }), 404
            
    except Exception as e:
        print(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç {trail_id}: {str(e)}")
        return jsonify({
            'error': '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞',
            'code': 'DATABASE_ERROR',
            'details': str(e) if app.debug else None
        }), 500


@app.route('/route/calculate', methods=['POST'])
def calculate_hiking_route():
    """
    –ò–∑—á–∏—Å–ª—è–≤–∞ –æ–ø—Ç–∏–º–∞–ª–µ–Ω –ø–µ—à–µ—Ö–æ–¥–µ–Ω –º–∞—Ä—à—Ä—É—Ç –º–µ–∂–¥—É –¥–≤–µ —Ç–æ—á–∫–∏.
    
    –ò–∑–ø–æ–ª–∑–≤–∞ OpenRouteService API –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ–¥—Ä–æ–±–µ–Ω –º–∞—Ä—à—Ä—É—Ç
    –æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω –∑–∞ –ø–ª–∞–Ω–∏–Ω—Å–∫–∏ —Ç—É—Ä–∏–∑—ä–º –∏ –ø–µ—à–µ—Ö–æ–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ.
    
    Returns:
        Response: GeoJSON –¥–∞–Ω–Ω–∏ –∑–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
        request_data = request.json
        if not request_data:
            return jsonify({
                'error': '–ù—è–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞',
                'code': 'NO_DATA'
            }), 400
        
        start_point = request_data.get('start')
        end_point = request_data.get('end')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
        if not start_point or not end_point:
            return jsonify({
                'error': '–ú–æ–ª—è, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ—Ç–µ –Ω–∞—á–∞–ª–Ω–∞ –∏ –∫—Ä–∞–π–Ω–∞ —Ç–æ—á–∫–∞',
                'code': 'MISSING_COORDINATES'
            }), 400
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ
        if not (isinstance(start_point, list) and len(start_point) == 2 and
                isinstance(end_point, list) and len(end_point) == 2):
            return jsonify({
                'error': '–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ. –û—á–∞–∫–≤–∞—Ç —Å–µ [longitude, latitude]',
                'code': 'INVALID_COORDINATE_FORMAT'
            }), 400
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏—Ç–µ
        start_valid, start_error = validate_coordinates(start_point[1], start_point[0])  # lat, lng
        if not start_valid:
            return jsonify({
                'error': f'–ù–∞—á–∞–ª–Ω–∞ —Ç–æ—á–∫–∞: {start_error}',
                'code': 'INVALID_START_COORDINATES'
            }), 400
        
        end_valid, end_error = validate_coordinates(end_point[1], end_point[0])  # lat, lng
        if not end_valid:
            return jsonify({
                'error': f'–ö—Ä–∞–π–Ω–∞ —Ç–æ—á–∫–∞: {end_error}',
                'code': 'INVALID_END_COORDINATES'
            }), 400
        
        print(f"üó∫Ô∏è –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç –æ—Ç {start_point} –¥–æ {end_point}")
        
        # –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —á—Ä–µ–∑ OpenRouteService
        route_data = ors_client.directions(
            coordinates=[start_point, end_point],
            profile='foot-hiking',  # –ü—Ä–æ—Ñ–∏–ª –∑–∞ –ø–ª–∞–Ω–∏–Ω—Å–∫–∏ —Ç—É—Ä–∏–∑—ä–º
            format='geojson',
            options={
                'avoid_features': ['highways'],  # –ò–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ –º–∞–≥–∏—Å—Ç—Ä–∞–ª–∏
                'preference': 'recommended'      # –ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç
            }
        )
        
        print("‚úÖ –ú–∞—Ä—à—Ä—É—Ç—ä—Ç –µ –∏–∑—á–∏—Å–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        return jsonify(route_data)
        
    except Exception as e:
        error_message = f"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞: {str(e)}"
        print(f"‚ùå {error_message}")
        
        return jsonify({
            'error': '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞',
            'code': 'ROUTING_ERROR',
            'details': str(e) if app.debug else None
        }), 500


@app.route("/trails/advanced_search", methods=['POST'])
def advanced_search_endpoint():
    """
    –ò–∑–≤—ä—Ä—à–≤–∞ —Ä–∞–∑—à–∏—Ä–µ–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏ –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–µ—Ä–∏–∏.
    
    –ü–æ–∑–≤–æ–ª—è–≤–∞ —Ñ–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω, —Ç—Ä—É–¥–Ω–æ—Å—Ç, —Å–µ–∑–æ–Ω
    –∏ –¥—Ä—É–≥–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–∞ –ø–æ-–ø—Ä–µ—Ü–∏–∑–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.
    
    Returns:
        Response: JSON —Å–ø–∏—Å—ä–∫ —Å –º–∞—Ä—à—Ä—É—Ç–∏ –æ—Ç–≥–æ–≤–∞—Ä—è—â–∏ –Ω–∞ –∫—Ä–∏—Ç–µ—Ä–∏–∏—Ç–µ
    """
    try:
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ
        search_params = request.json or {}
        
        region = search_params.get('region')
        difficulty = search_params.get('difficulty')
        best_season = search_params.get('best_season')
        
        # –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ
        if region:
            region = sanitize_user_input(str(region))
        if difficulty:
            difficulty = sanitize_user_input(str(difficulty))
        if best_season:
            best_season = sanitize_user_input(str(best_season))
        
        print(f"üîç –†–∞–∑—à–∏—Ä–µ–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ: —Ä–µ–≥–∏–æ–Ω='{region}', —Ç—Ä—É–¥–Ω–æ—Å—Ç='{difficulty}', —Å–µ–∑–æ–Ω='{best_season}'")
        
        # –ò–∑–≤—ä—Ä—à–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
        search_results = advanced_search(region, difficulty, best_season)
        
        print(f"‚úÖ –ù–∞–º–µ—Ä–µ–Ω–∏ {len(search_results)} –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–æ—Ç–æ —Ç—ä—Ä—Å–µ–Ω–µ")
        
        return jsonify({
            'results': search_results,
            'count': len(search_results),
            'search_criteria': {
                'region': region,
                'difficulty': difficulty,
                'best_season': best_season
            }
        })
        
    except Exception as e:
        print(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ: {str(e)}")
        return jsonify({
            'error': '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–æ—Ç–æ —Ç—ä—Ä—Å–µ–Ω–µ',
            'code': 'SEARCH_ERROR',
            'details': str(e) if app.debug else None
        }), 500


@app.route('/trails/all', methods=['GET'])
def get_all_trails():
    """
    –í—Ä—ä—â–∞ —Å–ø–∏—Å—ä–∫ —Å –≤—Å–∏—á–∫–∏ –Ω–∞–ª–∏—á–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏.
    
    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—è –æ–ø—Ä–æ—Å—Ç–µ–Ω–∞ –≤–µ—Ä—Å–∏—è —Å –æ—Å–Ω–æ–≤–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≤—Å–µ–∫–∏ –º–∞—Ä—à—Ä—É—Ç,
    –ø–æ–¥—Ö–æ–¥—è—â–∞ –∑–∞ —Å–ø–∏—Å—ä—Ü–∏ –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
    
    Returns:
        Response: JSON —Å–ø–∏—Å—ä–∫ —Å –≤—Å–∏—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏
    """
    try:
        # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –æ—Ç –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
        all_trails = list_all_trails()
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –ø–æ-–ª–µ—Å–Ω–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ
        formatted_trails = []
        for trail in all_trails:
            trail_summary = {
                'id': trail.get('id', ''),
                'name': trail.get('name', '–ù–µ–∏–º–µ–Ω–æ–≤–∞–Ω –º–∞—Ä—à—Ä—É—Ç'),
                'region': trail.get('location', {}).get('region', '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω —Ä–µ–≥–∏–æ–Ω'),
                'difficulty': trail.get('trail_details', {}).get('difficulty', '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
            }
            formatted_trails.append(trail_summary)
        
        print(f"üìã –í—Ä—ä—â–∞–Ω–µ –Ω–∞ {len(formatted_trails)} –º–∞—Ä—à—Ä—É—Ç–∞")
        
        return jsonify({
            'trails': formatted_trails,
            'total_count': len(formatted_trails)
        })
        
    except Exception as e:
        print(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏: {str(e)}")
        return jsonify({
            'error': '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ',
            'code': 'DATABASE_ERROR',
            'details': str(e) if app.debug else None
        }), 500

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–¶–ò –ù–ê –ì–†–ï–®–ö–ò
# ============================================================================

@app.errorhandler(404)
def handle_not_found(error):
    """
    –û–±—Ä–∞–±–æ—Ç–≤–∞ 404 –≥—Ä–µ—à–∫–∏ (—Ä–µ—Å—É—Ä—Å –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω).
    
    Args:
        error: –û–±–µ–∫—Ç—ä—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    
    Returns:
        Response: JSON –æ—Ç–≥–æ–≤–æ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    """
    return jsonify({
        'error': '–ó–∞—è–≤–µ–Ω–∏—è—Ç —Ä–µ—Å—É—Ä—Å –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω',
        'code': 'NOT_FOUND',
        'status': 404
    }), 404


@app.errorhandler(500)
def handle_internal_error(error):
    """
    –û–±—Ä–∞–±–æ—Ç–≤–∞ 500 –≥—Ä–µ—à–∫–∏ (–≤—ä—Ç—Ä–µ—à–Ω–∞ –≥—Ä–µ—à–∫–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞).
    
    Args:
        error: –û–±–µ–∫—Ç—ä—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    
    Returns:
        Response: JSON –æ—Ç–≥–æ–≤–æ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    """
    return jsonify({
        'error': '–í—ä–∑–Ω–∏–∫–Ω–∞ –≤—ä—Ç—Ä–µ—à–Ω–∞ –≥—Ä–µ—à–∫–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞',
        'code': 'INTERNAL_SERVER_ERROR',
        'status': 500,
        'details': str(error) if app.debug else None
    }), 500


@app.errorhandler(400)
def handle_bad_request(error):
    """
    –û–±—Ä–∞–±–æ—Ç–≤–∞ 400 –≥—Ä–µ—à–∫–∏ (–Ω–µ–≤–∞–ª–∏–¥–Ω–∞ –∑–∞—è–≤–∫–∞).
    
    Args:
        error: –û–±–µ–∫—Ç—ä—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    
    Returns:
        Response: JSON –æ—Ç–≥–æ–≤–æ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞
    """
    return jsonify({
        'error': '–ù–µ–≤–∞–ª–∏–¥–Ω–∞ –∑–∞—è–≤–∫–∞',
        'code': 'BAD_REQUEST',
        'status': 400,
        'details': str(error) if app.debug else None
    }), 400

# ============================================================================
# –°–¢–ê–†–¢–ò–†–ê–ù–ï –ù–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–ï–¢–û
# ============================================================================

if __name__ == '__main__':
    """
    –ì–ª–∞–≤–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.
    
    –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞ –∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —É–µ–± —Å—ä—Ä–≤—ä—Ä–∞ –≤ —Ä–µ–∂–∏–º –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
    —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –ø—Ä–∏ –ø—Ä–æ–º–µ–Ω–∏ –≤ –∫–æ–¥–∞.
    """
    print("üåø –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—è —á–∞—Ç–±–æ—Ç –∑–∞ –µ–∫–æ–ø—ä—Ç–µ–∫–∏...")
    print("üìç –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ —â–µ –±—ä–¥–µ –¥–æ—Å—Ç—ä–ø–Ω–æ –Ω–∞: http://localhost:5000")
    print("üîß –†–µ–∂–∏–º –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞: –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω")
    
    # –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ
    app.run(
        debug=True,           # –†–µ–∂–∏–º –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–∏ –≥—Ä–µ—à–∫–∏
        host='0.0.0.0',      # –î–æ—Å—Ç—ä–ø–Ω–æ –æ—Ç –≤—Å–∏—á–∫–∏ –º—Ä–µ–∂–æ–≤–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏
        port=5000,           # –ü–æ—Ä—Ç –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
        threaded=True        # –ú–Ω–æ–≥–æ–Ω–∏—à–∫–æ–≤–æ –æ–±—Å–ª—É–∂–≤–∞–Ω–µ –Ω–∞ –∑–∞—è–≤–∫–∏
    )
